<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>HPC Workflow Management with Snakemake: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="favicons/incubator/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicons/incubator/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicons/incubator/favicon-16x16.png">
<link rel="manifest" href="favicons/incubator/site.webmanifest">
<link rel="mask-icon" href="favicons/incubator/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      HPC Workflow Management with Snakemake
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            HPC Workflow Management with Snakemake
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  HPC Workflow Management with Snakemake
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-introduction.html">1. Running commands with Snakemake</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-snakemake_on_the_cluster.html">2. Running Snakemake on the cluster</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-placeholders.html">3. Placeholders</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-snakemake_and_mpi.html">4. MPI applications and Snakemake</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-chaining_rules.html">5. Chaining rules</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-expansion.html">6. Processing lists of inputs</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-introduction"><p>Content from <a href="01-introduction.html">Running commands with Snakemake</a></p>
<hr>
<p>Last updated on 2024-05-02 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/01-introduction.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I run a simple command with Snakemake?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Create a Snakemake recipe (a Snakefile)”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="what-is-the-workflow-im-interested-in">What is the workflow I’m interested in?<a class="anchor" aria-label="anchor" href="#what-is-the-workflow-im-interested-in"></a>
</h2>
<hr class="half-width">
<p>In this lesson we will make an experiment that takes an application
which runs in parallel and investigate it’s scalability. To do that we
will need to gather data, in this case that means running the
application multiple times with different numbers of CPU cores and
recording the execution time. Once we’ve done that we need to create a
visualisation of the data to see how it compares against the ideal
case.</p>
<p>From the visualisation we can then decide at what scale it makes most
sense to run the application at in production to maximise the use of our
CPU allocation on the system.</p>
<p>We could do all of this manually, but there are useful tools to help
us manage data analysis pipelines like we have in our experiment. Today
we’ll learn about one of those: Snakemake.</p>
<p>In order to get started with Snakemake, let’s begin by taking a
simple command and see how we can run that via Snakemake. Let’s choose
the command <code>hostname</code> which prints out the name of the host
where the command is executed:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ hostname</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">node1.int.jetstream2.hpc</span><span class="op">-</span><span class="va">carpentry.org</span></span></code></pre>
</div>
<p>That prints out the result but Snakemake relies on files to know the
status of your workflow, so let’s redirect the output to a file:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ hostname <span class="op">&gt;</span> hostname_login.txt</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="making-a-snakefile">Making a Snakefile<a class="anchor" aria-label="anchor" href="#making-a-snakefile"></a>
</h2>
<hr class="half-width">
<p>Edit a new text file named <code>Snakefile</code>.</p>
<p>Contents of <code>Snakefile</code>:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>rule hostname_login:</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    output: <span class="st">"hostname_login.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="bu">input</span>:  </span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    shell:</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_login.txt"</span></span></code></pre>
</div>
<div id="key-points-about-this-file" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="key-points-about-this-file" class="callout-inner">
<h3 class="callout-title">Key points about this file</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>The file is named <code>Snakefile</code> - with a capital
<code>S</code> and no file extension.</li>
<li>Some lines are indented. Indents must be with space characters, not
tabs. See the setup section for how to make your text editor do
this.</li>
<li>The rule definition starts with the keyword <code>rule</code>
followed by the rule name, then a colon.</li>
<li>We named the rule <code>hostname_login</code>. You may use letters,
numbers or underscores, but the rule name must begin with a letter and
may not be a keyword.</li>
<li>The keywords <code>input</code>, <code>output</code>, and
<code>shell</code> are all followed by a colon (“:”).</li>
<li>The file names and the shell command are all in
<code>"quotes"</code>.</li>
<li>The output filename is given before the input filename. In fact,
Snakemake doesn’t care what order they appear in but we give the output
first throughout this course. We’ll see why soon.</li>
<li>In this use case there is no input file for the command so we leave
this blank.</li>
</ol>
</div>
</div>
</div>
<p>Back in the shell we’ll run our new rule. At this point, if there
were any missing quotes, bad indents, etc., we may see an error.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-j1</span> <span class="at">-p</span> hostname_login</span></code></pre>
</div>
<div id="bash-snakemake-command-not-found..." class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="bash-snakemake-command-not-found..." class="callout-inner">
<h3 class="callout-title"><code>bash: snakemake: command not found...</code></h3>
<div class="callout-content">
<p>If your shell tells you that it cannot find the command
<code>snakemake</code> then we need to make the software available
somehow. In our case, this means searching for the module that we need
to load:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">module</span> spider snakemake</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[ocaisa@node1 ~]$ module spider snakemake

--------------------------------------------------------------------------------------------------------
  snakemake:
--------------------------------------------------------------------------------------------------------
     Versions:
        snakemake/8.2.1-foss-2023a
        snakemake/8.2.1 (E)

Names marked by a trailing (E) are extensions provided by another module.


--------------------------------------------------------------------------------------------------------
  For detailed information about a specific "snakemake" package (including how to load the modules) use the module's full name.
  Note that names that have a trailing (E) are extensions provided by other modules.
  For example:

     $ module spider snakemake/8.2.1
--------------------------------------------------------------------------------------------------------</code></pre>
</div>
<p>Now we want the module, so let’s load that to make the package
available</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ module load snakemake</span></code></pre>
</div>
<p>and then make sure we have the <code>snakemake</code> command
available</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ which snakemake</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>/cvmfs/software.eessi.io/host_injections/2023.06/software/linux/x86_64/amd/zen3/software/snakemake/8.2.1-foss-2023a/bin/snakemake</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">-j1</span> <span class="at">-p</span> hostname_login</span></code></pre>
</div>
</div>
</div>
</div>
<div id="running-snakemake" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="running-snakemake" class="callout-inner">
<h3 class="callout-title">Running Snakemake</h3>
<div class="callout-content">
<p>Run <code>snakemake --help | less</code> to see the help for all
available options. What does the <code>-p</code> option in the
<code>snakemake</code> command above do?</p>
<ol style="list-style-type: decimal">
<li>Protects existing output files</li>
<li>Prints the shell commands that are being run to the terminal</li>
<li>Tells Snakemake to only run one process at a time</li>
<li>Prompts the user for the correct input file</li>
</ol>
</div>
</div>
</div>
<div id="accordionHint1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button hint-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHint1" aria-expanded="false" aria-controls="collapseHint1">
  <h4 class="accordion-header" id="headingHint1"> Give me a hint </h4>
</button>
<div id="collapseHint1" class="accordion-collapse collapse" aria-labelledby="headingHint1" data-bs-parent="#accordionHint1">
<div class="accordion-body">
<p>You can search in the text by pressing <kbd>/</kbd>, and quit back to
the shell with <kbd>q</kbd>.</p>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<ol start="2" style="list-style-type: decimal">
<li>Prints the shell commands that are being run to the terminal</li>
</ol>
<p>This is such a useful thing we don’t know why it isn’t the default!
The <code>-j1</code> option is what tells Snakemake to only run one
process at a time, and we’ll stick with this for now as it makes things
simpler. Answer 4 is a total red-herring, as Snakemake never prompts
interactively for user input.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Before running Snakemake you need to write a Snakefile”</li>
<li>“A Snakefile is a text file which defines a list of rules”</li>
<li>“Rules have inputs, outputs, and shell commands to be run”</li>
<li>“You tell Snakemake what file to make and it will run the shell
command defined in the appropriate rule”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-02-snakemake_on_the_cluster"><p>Content from <a href="02-snakemake_on_the_cluster.html">Running Snakemake on the cluster</a></p>
<hr>
<p>Last updated on 2024-12-05 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/02-snakemake_on_the_cluster.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I run my Snakemake rule on the cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Define rules to run locally and on the cluster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>What happens when we want to make our rule run on the cluster rather
than the login node? The cluster we are using uses Slurm, and it happens
that Snakemake has built in support for Slurm, we just need to tell it
that we want to use it.</p>
<p>Snakemake uses the <code>executor</code> option to allow you to
select the plugin that you wish to execute the rule. The quickest way to
apply this to your Snakefile is to define this on the command line.
Let’s try it out</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">-j1</span> <span class="at">-p</span> <span class="at">--executor</span> slurm hostname_login</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Retrieving input from storage.
Nothing to be done (all requested files are present and up to date).</code></pre>
</div>
<p>Nothing happened! Why not? When it is asked to build a target,
Snakemake checks the ‘last modification time’ of both the target and its
dependencies. If any dependency has been updated since the target, then
the actions are re-run to update the target. Using this approach,
Snakemake knows to only rebuild the files that, either directly or
indirectly, depend on the file that changed. This is called an
<em>incremental build</em>.</p>
<div id="incremental-builds-improve-efficiency" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="incremental-builds-improve-efficiency" class="callout-inner">
<h3 class="callout-title">Incremental Builds Improve Efficiency</h3>
<div class="callout-content">
<p>By only rebuilding files when required, Snakemake makes your
processing more efficient.</p>
</div>
</div>
</div>
<div id="running-on-the-cluster" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="running-on-the-cluster" class="callout-inner">
<h3 class="callout-title">Running on the cluster</h3>
<div class="callout-content">
<p>We need another rule now that executes the <code>hostname</code> on
the <em>cluster</em>. Create a new rule in your Snakefile and try to
execute it on cluster with the option <code>--executor slurm</code> to
<code>snakemake</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The rule is almost identical to the previous rule save for the rule
name and output file:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    shell:</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_remote.txt"</span></span></code></pre>
</div>
<p>You can then execute the rule with</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">-j1</span> <span class="at">-p</span> <span class="at">--executor</span> slurm hostname_remote</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Building DAG of jobs...
Retrieving input from storage.
Using shell: /cvmfs/software.eessi.io/versions/2023.06/compat/linux/x86_64/bin/bash
Provided remote nodes: 1
Job stats:
job                count
---------------  -------
hostname_remote        1
total                  1

Select jobs to execute...
Execute 1 jobs...

[Mon Jan 29 18:03:46 2024]
rule hostname_remote:
    output: hostname_remote.txt
    jobid: 0
    reason: Missing output files: hostname_remote.txt
    resources: tmpdir=&lt;TBD&gt;

hostname &gt; hostname_remote.txt
No SLURM account given, trying to guess.
Guessed SLURM account: def-users
No wall time information given. This might or might not work on your cluster.
If not, specify the resource runtime in your rule or as a reasonable default
via --default-resources. No job memory information ('mem_mb' or
'mem_mb_per_cpu') is given - submitting without.
This might or might not work on your cluster.
Job 0 has been submitted with SLURM jobid 326 (log: /home/ocaisa/.snakemake/slurm_logs/rule_hostname_remote/326.log).
[Mon Jan 29 18:04:26 2024]
Finished job 0.
1 of 1 steps (100%) done
Complete log: .snakemake/log/2024-01-29T180346.788174.snakemake.log</code></pre>
</div>
<p>Note all the warnings that Snakemake is giving us about the fact that
the rule may not be able to execute on our cluster as we may not have
given enough information. Luckily for us, this actually works on our
cluster and we can take a look in the output file the new rule creates,
<code>hostname_remote.txt</code>:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ cat hostname_remote.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">tmpnode1.int.jetstream2.hpc</span><span class="op">-</span><span class="va">carpentry.org</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="snakemake-profile">Snakemake profile<a class="anchor" aria-label="anchor" href="#snakemake-profile"></a>
</h2>
<hr class="half-width">
<p>Adapting Snakemake to a particular environment can entail many flags
and options. Therefore, it is possible to specify a configuration
profile to be used to obtain default options. This looks like</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> myprofileFolder ...</span></code></pre>
</div>
<p>The profile folder must contain a file called
<code>config.yaml</code> which is what will store our options. The
folder may also contain other files necessary for the profile. Let’s
create the file <code>cluster_profile/config.yaml</code> and insert some
of our existing options:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span></code></pre>
</div>
<p>We should now be able rerun our workflow by pointing to the profile
rather than the listing out the options. To force our workflow to rerun,
we first need to remove the output file
<code>hostname_remote.txt</code>, and then we can try out our new
profile</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ rm hostname_remote.txt</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">--profile</span> cluster_profile hostname_remote</span></code></pre>
</div>
<p>The profile is extremely useful in the context of our cluster, as the
Slurm executor has lots of options, and sometimes you need to use them
to be able to submit jobs to the cluster you have access to.
Unfortunately, the names of the options in Snakemake are not
<em>exactly</em> the same as those of Slurm, so we need the help of a
translation table:</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="18%">
<col width="62%">
</colgroup>
<thead><tr class="header">
<th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>--partition</code></td>
<td><code>slurm_partition</code></td>
<td>the partition a rule/job is to use</td>
</tr>
<tr class="even">
<td><code>--time</code></td>
<td><code>runtime</code></td>
<td>the walltime per job in minutes</td>
</tr>
<tr class="odd">
<td><code>--constraint</code></td>
<td><code>constraint</code></td>
<td>may hold features on some clusters</td>
</tr>
<tr class="even">
<td><code>--mem</code></td>
<td><code>mem, mem_mb</code></td>
<td>memory a cluster node must</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>provide (mem: string with unit), mem_mb: int</td>
</tr>
<tr class="even">
<td><code>--mem-per-cpu</code></td>
<td><code>mem_mb_per_cpu</code></td>
<td>memory per reserved CPU</td>
</tr>
<tr class="odd">
<td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr>
<tr class="even">
<td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr>
<tr class="odd">
<td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr>
</tbody>
</table>
<p>The warnings given by Snakemake hinted that we may need to provide
these options. One way to do it is to provide them is as part of the
Snakemake rule using the keyword <code>resources</code>, e.g.,</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>rule:</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    <span class="bu">input</span>: ...</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    output: ...</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    resources:</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>        partition <span class="op">=</span> <span class="op">&lt;</span>partition name<span class="op">&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>        runtime <span class="op">=</span> <span class="op">&lt;</span>some number<span class="op">&gt;</span></span></code></pre>
</div>
<p>and we can also use the profile to define default values for these
options to use with our project, using the keyword
<code>default-resources</code>. For example, the available memory on our
cluster is about 4GB per core, so we can add that to our profile:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>We know that our problem runs in a very short time. Change the
default length of our jobs to two minutes for Slurm.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>There are various <code>sbatch</code> options not directly supported
by the resource definitions in the table above. You may use the
<code>slurm_extra</code> resource to specify any of these additional
flags to <code>sbatch</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>rule myrule:</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    <span class="bu">input</span>: ...</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    output: ...</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    resources:</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>        slurm_extra<span class="op">=</span><span class="st">"--mail-type=ALL --mail-user=&lt;your email&gt;"</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="local-rule-execution">Local rule execution<a class="anchor" aria-label="anchor" href="#local-rule-execution"></a>
</h2>
<hr class="half-width">
<p>Our initial rule was to get the hostname of the login node. We always
want to run that rule on the login node for that to make sense. If we
tell Snakemake to run all rules via the Slurm executor (which is what we
are doing via our new profile) this won’t happen any more. So how do we
force the rule to run on the login node?</p>
<p>Well, in the case where a Snakemake rule performs a trivial task job
submission might be overkill (e.g., less than 1 minute worth of compute
time). Similar to our case, it would be a better idea to have these
rules execute locally (i.e. where the <code>snakemake</code> command is
run) instead of as a job. Snakemake lets you indicate which rules should
always run locally with the <code>localrules</code> keyword. Let’s
define <code>hostname_login</code> as a local rule near the top of our
<code>Snakefile</code>.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>localrules: hostname_login</span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Snakemake generates and submits its own batch scripts for your
scheduler.”</li>
<li>“You can store default configuration settings in a Snakemake
profile”</li>
<li>“<code>localrules</code> defines rules that are executed locally,
and never submitted to a cluster.”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-03-placeholders"><p>Content from <a href="03-placeholders.html">Placeholders</a></p>
<hr>
<p>Last updated on 2024-05-02 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/03-placeholders.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I make a generic rule?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“See how Snakemake deals with some errors”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Our Snakefile has some duplication. For example, the names of text
files are repeated in places throughout the Snakefile rules. Snakefiles
are a form of code and, in any code, repetition can lead to problems
(e.g. we rename a data file in one part of the Snakefile but forget to
rename it elsewhere).</p>
<div id="d.r.y.-dont-repeat-yourself" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="d.r.y.-dont-repeat-yourself" class="callout-inner">
<h3 class="callout-title">D.R.Y. (Don’t Repeat Yourself)</h3>
<div class="callout-content">
<p>In many programming languages, the bulk of the language features are
there to allow the programmer to describe long-winded computational
routines as short, expressive, beautiful code. Features in Python, R, or
Java, such as user-defined variables and functions are useful in part
because they mean we don’t have to write out (or think about) all of the
details over and over again. This good habit of writing things out only
once is known as the “Don’t Repeat Yourself” principle or D.R.Y.</p>
</div>
</div>
</div>
<p>Let us set about removing some of the repetition from our
Snakefile.</p>
<section><h2 class="section-heading" id="placeholders">Placeholders<a class="anchor" aria-label="anchor" href="#placeholders"></a>
</h2>
<hr class="half-width">
<p>To make a more general-purpose rule we need
<strong>placeholders</strong>. Let’s take a look at what a placeholder
looks like</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    shell:</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>        <span class="co">"hostname &gt; {output}"</span></span></code></pre>
</div>
<p>As a reminder, here’s the previous version from the last episode:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule hostname_remote:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"hostname_remote.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"hostname &gt; hostname_remote.txt"</span></span></code></pre>
</div>
<p>The new rule has replaced explicit file names with things in
<code>{curly brackets}</code>, specifically <code>{output}</code> (but
it could also have been <code>{input}</code>…if that had a value and
were useful).</p>
<div class="section level3">
<h3 id="input-and-output-are-placeholders">
<code>{input}</code> and <code>{output}</code> are
<strong>placeholders</strong>
<a class="anchor" aria-label="anchor" href="#input-and-output-are-placeholders"></a>
</h3>
<p>Placeholders are used in the <code>shell</code> section of a rule,
and Snakemake will replace them with appropriate values -
<code>{input}</code> with the full name of the input file, and
<code>{output}</code> with the full name of the output file – before
running the command.</p>
<p><code>{resources}</code> is also a placeholder, and we can access a
named element of the <code>{resources}</code> with the notation
<code>{resources.runtime}</code> (for example).</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Snakemake rules are made more generic with placeholders”</li>
<li>“Placeholders in the shell part of the rule are replaced with values
based on the chosen wildcards”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-04-snakemake_and_mpi"><p>Content from <a href="04-snakemake_and_mpi.html">MPI applications and Snakemake</a></p>
<hr>
<p>Last updated on 2024-05-02 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/04-snakemake_and_mpi.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I run an MPI application via Snakemake on the cluster?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Define rules to run locally and on the cluster”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>Now it’s time to start getting back to our real workflow. We can
execute a command on the cluster, but what about executing the MPI
application we are interested in? Our application is called
<code>amdahl</code> and is available as an environment module.</p>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Locate and load the <code>amdahl</code> module and then
<em>replace</em> our <code>hostname_remote</code> rule with a version
that runs <code>amdahl</code>. (Don’t worry about parallel MPI just yet,
run it with a single CPU, <code>mpiexec -n 1 amdahl</code>).</p>
<p>Does your rule execute correctly? If not look through the log files
to find out why?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">module</span> spider amdahl</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">module</span> load amdahl</span></code></pre>
</div>
<p>will locate and then load the <code>amdahl</code> module. We can then
update/replace our rule to run the <code>amdahl</code> application:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>However, when we try to execute the rule we get an error (unless you
already have a different version of <code>amdahl</code> available in
your path). Snakemake reports the location of the logs and if we look
inside we can (eventually) find</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>...
mpiexec -n 1 amdahl &gt; amdahl_run.txt
--------------------------------------------------------------------------
mpiexec was unable to find the specified executable file, and therefore
did not launch the job.  This error was first reported for process
rank 0; it may have occurred for other processes as well.

NOTE: A common cause for this error is misspelling a mpiexec command
      line parameter option (remember that mpiexec interprets the first
      unrecognized command line token as the executable).

Node:       tmpnode1
Executable: amdahl
--------------------------------------------------------------------------
...</code></pre>
</div>
<p>So, even though we loaded the module before running the workflow, our
Snakemake rule didn’t find the executable. That’s because the Snakemake
rule is running in a clean <em>runtime environment</em>, and we need to
somehow tell it to load the necessary environment module before trying
to execute the rule.</p>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="snakemake-and-environment-modules">Snakemake and environment modules<a class="anchor" aria-label="anchor" href="#snakemake-and-environment-modules"></a>
</h2>
<hr class="half-width">
<p>Our application is called <code>amdahl</code> and is available on the
system via an environment module, so we need to tell Snakemake to load
the module before it tries to execute the rule. Snakemake is aware of
environment modules, and these can be specified via (yet another)
option:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>      <span class="co">"mpi4py"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    shell:</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>        <span class="co">"mpiexec -n 1 amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Adding these lines are not enough to make the rule execute however.
Not only do you have to tell Snakemake what modules to load, but you
also have to tell it to use environment modules in general (since the
use of environment modules is considered to make your runtime
environment less reproducible as the available modules may differ from
cluster to cluster). This requires you to give Snakemake an additonal
option</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile <span class="at">--use-envmodules</span> amdahl_run</span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>We’ll be using environment modules throughout the rest of tutorial,
so make that a default option of our profile (by setting it’s value to
<code>True</code>)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>Update our cluster profile to</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">YAML<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode yaml" tabindex="0"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">printshellcmds</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="fu">executor</span><span class="kw">:</span><span class="at"> slurm</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="fu">default-resources</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> mem_mb_per_cpu=3600</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> runtime=2</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="fu">use-envmodules</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span></code></pre>
</div>
<p>If you want to test it, you need to erase the output file of the rule
and rerun Snakemake.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="snakemake-and-mpi">Snakemake and MPI<a class="anchor" aria-label="anchor" href="#snakemake-and-mpi"></a>
</h2>
<hr class="half-width">
<p>We didn’t really run an MPI application in the last section as we
only ran on one core. How do we request to run on multiple cores for a
single rule?</p>
<p>Snakemake has general support for MPI, but the only executor that
currently explicitly supports MPI is the Slurm executor (lucky for us!).
If we look back at our Slurm to Snakemake translation table we notice
the relevant options appear near the bottom:</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="18%">
<col width="62%">
</colgroup>
<thead><tr class="header">
<th>SLURM</th>
<th>Snakemake</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="even">
<td><code>--ntasks</code></td>
<td><code>tasks</code></td>
<td>number of concurrent tasks / ranks</td>
</tr>
<tr class="odd">
<td><code>--cpus-per-task</code></td>
<td><code>cpus_per_task</code></td>
<td>number of cpus per task (in case of SMP, rather use
<code>threads</code>)</td>
</tr>
<tr class="even">
<td><code>--nodes</code></td>
<td><code>nodes</code></td>
<td>number of nodes</td>
</tr>
</tbody>
</table>
<p>The one we are interested is <code>tasks</code> as we are only going
to increase the number of ranks. We can define these in a
<code>resources</code> section of our rule and refer to them using
placeholders:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run.txt"</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    resources:</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">'mpiexec'</span>,</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>      tasks<span class="op">=</span><span class="dv">2</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    shell:</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>That worked but now we have a bit of an issue. We want to do this for
a few different values of <code>tasks</code> that would mean we would
need a different output file for every run. It would be great if we can
somehow indicate in the <code>output</code> the value that we want to
use for <code>tasks</code>…and have Snakemake pick that up.</p>
<p>We could use a <em>wildcard</em> in the <code>output</code> to allow
us to define the <code>tasks</code> we wish to use. The syntax for such
a wildcard looks like</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span></code></pre>
</div>
<p>where <code>parallel_tasks</code> is our wildcard.</p>
<div id="wildcards" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="wildcards" class="callout-inner">
<h3 class="callout-title">Wildcards</h3>
<div class="callout-content">
<p>Wildcards are used in the <code>input</code> and <code>output</code>
lines of the rule to represent parts of filenames. Much like the
<code>*</code> pattern in the shell, the wildcard can stand in for any
text in order to make up the desired filename. As with naming your
rules, you may choose any name you like for your wildcards, so here we
used <code>parallel_tasks</code>. Using the same wildcards in the input
and output is what tells Snakemake how to match input files to output
files.</p>
<p>If two rules use a wildcard with the same name then Snakemake will
treat them as different entities - rules in Snakemake are self-contained
in this way.</p>
<p>In the <code>shell</code> line you can reference the wildcard with
<code>{wildcards.parallel_tasks}</code></p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="snakemake-order-of-operations">Snakemake order of operations<a class="anchor" aria-label="anchor" href="#snakemake-order-of-operations"></a>
</h2>
<hr class="half-width">
<p>We’re only just getting started with some simple rules, but it’s
worth thinking about exactly what Snakemake is doing when you run it.
There are three distinct phases:</p>
<ol style="list-style-type: decimal">
<li>Prepares to run:
<ol style="list-style-type: decimal">
<li>Reads in all the rule definitions from the Snakefile</li>
</ol>
</li>
<li>Plans what to do:
<ol style="list-style-type: decimal">
<li>Sees what file(s) you are asking it to make</li>
<li>Looks for a matching rule by looking at the <code>output</code>s of
all the rules it knows</li>
<li>Fills in the wildcards to work out the <code>input</code> for this
rule</li>
<li>Checks that this input file (if required) is actually available</li>
</ol>
</li>
<li>Runs the steps:
<ol style="list-style-type: decimal">
<li>Creates the directory for the output file, if needed</li>
<li>Removes the old output file if it is already there</li>
<li>Only then, runs the shell command with the placeholders
replaced</li>
<li>Checks that the command ran without errors <em>and</em> made the new
output file as expected</li>
</ol>
</li>
</ol>
<div id="dry-run--n-mode" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="dry-run--n-mode" class="callout-inner">
<h3 class="callout-title">Dry-run (<code>-n</code>) mode</h3>
<div class="callout-content">
<p>It’s often useful to run just the first two phases, so that Snakemake
will plan out the jobs to run, and print them to the screen, but never
actually run them. This is done with the <code>-n</code> flag, eg:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="op">&gt;</span> $ <span class="ex">snakemake</span> <span class="at">-n</span> ...</span></code></pre>
</div>
</div>
</div>
</div>
<p>The amount of checking may seem pedantic right now, but as the
workflow gains more steps this will become very useful to us indeed.</p>
</section><section><h2 class="section-heading" id="using-wildcards-in-our-rule">Using wildcards in our rule<a class="anchor" aria-label="anchor" href="#using-wildcards-in-our-rule"></a>
</h2>
<hr class="half-width">
<p>We would like to use a wildcard in the <code>output</code> to allow
us to define the number of <code>tasks</code> we wish to use. Based on
what we’ve seen so far, you might imagine this could look like</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    resources:</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>      tasks<span class="op">=</span><span class="st">"</span><span class="sc">{parallel_tasks}</span><span class="st">"</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    shell:</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>but there are two problems with this:</p>
<ul>
<li>The only way for Snakemake to know the value of the wildcard is for
the user to explicitly request a concrete output file (rather than call
the rule):</li>
</ul>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>  <span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile amdahl_run_2.txt</span></code></pre>
</div>
<p>This is perfectly valid, as Snakemake can figure out that it has a
rule that can match that filename.</p>
<ul>
<li>
<p>The bigger problem is that even doing that does not work, it
seems we cannot use a wildcard for <code>tasks</code>:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>WorkflowError:
SLURM job submission failed. The error message was sbatch:
error: Invalid numeric value "{parallel_tasks}" for --ntasks.</code></pre>
</div>
</li>
</ul>
<p>Unfortunately for us, there is no direct way for us to access the
wildcards for <code>tasks</code>. The reason for this is that Snakemake
tries to use the value of <code>tasks</code> during its initialisation
stage, which is before we know the value of the wildcard. We need to
defer the determination of <code>tasks</code> to later on. This can be
achieved by specifying an input function instead of a value for this
scenario. The solution then is to write a one-time use function to
manipulate Snakemake into doing this for us. Since the function is
specifically for the rule, we can use a one-line function without a
name. These kinds of functions are called either anonymous functions or
lamdba functions (both mean the same thing), and are a feature of Python
(and other programming languages).</p>
<p>To define a lambda function in python, the general syntax is as
follows:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">lambda</span> x: x <span class="op">+</span> <span class="dv">54</span></span></code></pre>
</div>
<p>Since our function <em>can</em> take the wildcards as arguments, we
can use that to set the value for <code>tasks</code>:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    output: <span class="st">"amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    resources:</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>    shell:</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<p>Now we have a rule that can be used to generate output from runs of
an arbitrary number of parallel tasks.</p>
<div id="comments-in-snakefiles" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="comments-in-snakefiles" class="callout-inner">
<h3 class="callout-title">Comments in Snakefiles</h3>
<div class="callout-content">
<p>In the above code, the line beginning <code>#</code> is a comment
line. Hopefully you are already in the habit of adding comments to your
own scripts. Good comments make any script more readable, and this is
just as true with Snakefiles.</p>
</div>
</div>
</div>
<p>Since our rule is now capable of generating an arbitrary number of
output files things could get very crowded in our current directory.
It’s probably best then to put the runs into a separate folder to keep
things tidy. We can add the folder directly to our <code>output</code>
and Snakemake will take of directory creation for us:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    output: <span class="st">"runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.txt"</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    resources:</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    shell:</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Create an output file (under the <code>runs</code> folder) for the
case where we have 6 parallel tasks</p>
<p>(HINT: Remember that Snakemake needs to be able to match the
requested file to the <code>output</code> from a rule)</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile runs/amdahl_run_6.txt</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Another thing about our application <code>amdahl</code> is that we
ultimately want to process the output to generate our scaling plot. The
output right now is useful for reading but makes processing harder.
<code>amdahl</code> has an option that actually makes this easier for
us. To see the <code>amdahl</code> options we can use</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ module load amdahl</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ amdahl <span class="at">--help</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>usage: amdahl [-h] [-p [PARALLEL_PROPORTION]] [-w [WORK_SECONDS]] [-t] [-e]

options:
  -h, --help            show this help message and exit
  -p [PARALLEL_PROPORTION], --parallel-proportion [PARALLEL_PROPORTION]
                        Parallel proportion should be a float between 0 and 1
  -w [WORK_SECONDS], --work-seconds [WORK_SECONDS]
                        Total seconds of workload, should be an integer greater than 0
  -t, --terse           Enable terse output
  -e, --exact           Disable random jitter</code></pre>
</div>
<p>The option we are looking for is <code>--terse</code>, and that will
make <code>amdahl</code> print output in a format that is much easier to
process, JSON. JSON format in a file typically uses the file extension
<code>.json</code> so let’s add that option to our <code>shell</code>
command <em>and</em> change the file format of the <code>output</code>
to match our new command:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    output: <span class="st">"runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.json"</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    resources:</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>    shell:</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl --terse &gt; {output}"</span></span></code></pre>
</div>
<p>There was another parameter for <code>amdahl</code> that caught my
eye. <code>amdahl</code> has an option
<code>--parallel-proportion</code> (or <code>-p</code>) which we might
be interested in changing as it changes the behaviour of the code,and
therefore has an impact on the values we get in our results. Let’s add
another directory layer to our output format to reflect a particular
choice for this value. We can use a wildcard so we done have to choose
the value right away:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>rule amdahl_run:</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{parallel_tasks}</span><span class="st">.json"</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>      <span class="co">"amdahl"</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    resources:</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>      mpi<span class="op">=</span><span class="st">"mpiexec"</span>,</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>      <span class="co"># No direct way to access the wildcard in tasks, so we need to do this</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>      <span class="co"># indirectly by declaring a short function that takes the wildcards as an</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>      <span class="co"># argument</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>      tasks<span class="op">=</span><span class="kw">lambda</span> wildcards: <span class="bu">int</span>(wildcards.parallel_tasks)</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>    <span class="bu">input</span>:</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>    shell:</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>        <span class="co">"{resources.mpi} -n {resources.tasks} amdahl --terse -p {wildcards.parallel_proportion} &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge4" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Create an output file for a value of <code>-p</code> of 0.999 (the
default value is 0.8) for the case where we have 6 parallel tasks.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile p_0.999/runs/amdahl_run_6.json</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Snakemake chooses the appropriate rule by replacing wildcards such
that the output matches the target”</li>
<li>“Snakemake checks for various error conditions and will stop if it
sees a problem”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-05-chaining_rules"><p>Content from <a href="05-chaining_rules.html">Chaining rules</a></p>
<hr>
<p>Last updated on 2024-05-02 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/05-chaining_rules.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I combine rules into a workflow?”</li>
<li>“How do I make a rule with multiple inputs and outputs?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="a-pipeline-of-multiple-rules">A pipeline of multiple rules<a class="anchor" aria-label="anchor" href="#a-pipeline-of-multiple-rules"></a>
</h2>
<hr class="half-width">
<p>We now have a rule that can generate output for any value of
<code>-p</code> and any number of tasks, we just need to call Snakemake
with the parameters that we want:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile p_0.999/runs/amdahl_run_6.json</span></code></pre>
</div>
<p>That’s not exactly convenient though, to generate a full dataset we
have to run Snakemake lots of times with different output file targets.
Rather than that, let’s create a rule that can generate those files for
us.</p>
<p>Chaining rules in Snakemake is a matter of choosing filename patterns
that connect the rules. There’s something of an art to it - most times
there are several options that will work:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="bu">input</span>:  <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_6.json"</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    shell:</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>The new rule is doing no work, it’s just making sure we create the
file we want. It’s not worth executing on the cluster. How do ensure it
runs on the login node only?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>We need to add the new rule to our <code>localrules</code>:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>localrules: hostname_login, generate_run_files</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Now let’s run the new rule (remember we need to request the output
file by name as the <code>output</code> in our rule contains a wildcard
pattern):</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">[ocaisa@node1</span> ~]$ snakemake <span class="at">--profile</span> cluster_profile/ p_0.999_runs.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Using profile cluster_profile/ for setting default command line arguments.
Building DAG of jobs...
Retrieving input from storage.
Using shell: /cvmfs/software.eessi.io/versions/2023.06/compat/linux/x86_64/bin/bash
Provided remote nodes: 3
Job stats:
job                   count
------------------  -------
amdahl_run                1
generate_run_files        1
total                     2

Select jobs to execute...
Execute 1 jobs...

[Tue Jan 30 17:39:29 2024]
rule amdahl_run:
    output: p_0.999/runs/amdahl_run_6.json
    jobid: 1
    reason: Missing output files: p_0.999/runs/amdahl_run_6.json
    wildcards: parallel_proportion=0.999, parallel_tasks=6
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954,
               tmpdir=&lt;TBD&gt;, mem_mb_per_cpu=3600, runtime=2, mpi=mpiexec, tasks=6

mpiexec -n 6 amdahl --terse -p 0.999 &gt; p_0.999/runs/amdahl_run_6.json
No SLURM account given, trying to guess.
Guessed SLURM account: def-users
Job 1 has been submitted with SLURM jobid 342 (log: /home/ocaisa/.snakemake/slurm_logs/rule_amdahl_run/342.log).
[Tue Jan 30 17:47:31 2024]
Finished job 1.
1 of 2 steps (50%) done
Select jobs to execute...
Execute 1 jobs...

[Tue Jan 30 17:47:31 2024]
localrule generate_run_files:
    input: p_0.999/runs/amdahl_run_6.json
    output: p_0.999_runs.txt
    jobid: 0
    reason: Missing output files: p_0.999_runs.txt;
            Input files updated by another job: p_0.999/runs/amdahl_run_6.json
    wildcards: parallel_proportion=0.999
    resources: mem_mb=1000, mem_mib=954, disk_mb=1000, disk_mib=954,
               tmpdir=/tmp, mem_mb_per_cpu=3600, runtime=2

echo p_0.999/runs/amdahl_run_6.json done &gt; p_0.999_runs.txt
[Tue Jan 30 17:47:31 2024]
Finished job 0.
2 of 2 steps (100%) done
Complete log: .snakemake/log/2024-01-30T173929.781106.snakemake.log</code></pre>
</div>
<p>Look at the logging messages that Snakemake prints in the terminal.
What has happened here?</p>
<ol style="list-style-type: decimal">
<li>Snakemake looks for a rule to make
<code>p_0.999_runs.txt</code>
</li>
<li>It determines that “generate_run_files” can make this if
<code>parallel_proportion=0.999</code>
</li>
<li>It sees that the input needed is therefore
<code>p_0.999/runs/amdahl_run_6.json</code>
</li>
<li>Snakemake looks for a rule to make
<code>p_0.999/runs/amdahl_run_6.json</code>
</li>
<li>It determines that “amdahl_run” can make this if
<code>parallel_proportion=0.999</code> and
<code>parallel_tasks=6</code>
</li>
<li>Now Snakemake has reached an available input file (in this case, no
input file is actually required), it runs both steps to get the final
output</li>
</ol>
<p>This, in a nutshell, is how we build workflows in Snakemake.</p>
<ol style="list-style-type: decimal">
<li>Define rules for all the processing steps</li>
<li>Choose <code>input</code> and <code>output</code> naming patterns
that allow Snakemake to link the rules</li>
<li>Tell Snakemake to generate the final output file(s)</li>
</ol>
<p>If you are used to writing regular scripts this takes a little
getting used to. Rather than listing steps in order of execution, you
are alway <strong>working backwards</strong> from the final desired
result. The order of operations is determined by applying the pattern
matching rules to the filenames, not by the order of the rules in the
Snakefile.</p>
<div id="outputs-first" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="outputs-first" class="callout-inner">
<h3 class="callout-title">Outputs first?</h3>
<div class="callout-content">
<p>The Snakemake approach of working backwards from the desired output
to determine the workflow is why we’re putting the <code>output</code>
lines first in all our rules - to remind us that these are what
Snakemake looks at first!</p>
<p>Many users of Snakemake, and indeed the official documentation,
prefer to have the <code>input</code> first, so in practice you should
use whatever order makes sense to you.</p>
</div>
</div>
</div>
<div id="log-outputs-in-snakemake" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="log-outputs-in-snakemake" class="callout-inner">
<h3 class="callout-title">
<code>log</code> outputs in Snakemake</h3>
<div class="callout-content">
<p>Snakemake has a dedicated rule field for outputs that are <a href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#log-files" class="external-link">log
files</a>, and these are mostly treated as regular outputs except that
log files are not removed if the job produces an error. This means you
can look at the log to help diagnose the error. In a real workflow this
can be very useful, but in terms of learning the fundamentals of
Snakemake we’ll stick with regular <code>input</code> and
<code>output</code> fields here.</p>
</div>
</div>
</div>
<div id="errors-are-normal" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="errors-are-normal" class="callout-inner">
<h3 class="callout-title">Errors are normal</h3>
<div class="callout-content">
<p>Don’t be disheartened if you see errors when first testing your new
Snakemake pipelines. There is a lot that can go wrong when writing a new
workflow, and you’ll normally need several iterations to get things just
right. One advantage of the Snakemake approach compared to regular
scripts is that Snakemake fails fast when there is a problem, rather
than ploughing on and potentially running junk calculations on partial
or corrupted data. Another advantage is that when a step fails we can
safely resume from where we left off.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Snakemake links rules by iteratively looking for rules that make
missing inputs”</li>
<li>“Rules may have multiple named inputs and/or outputs”</li>
<li>“If a shell command does not yield an expected output then Snakemake
will regard that as a failure”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-06-expansion"><p>Content from <a href="06-expansion.html">Processing lists of inputs</a></p>
<hr>
<p>Last updated on 2024-06-20 |

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/episodes/06-expansion.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>“How do I process multiple files at once?”</li>
<li>“How do I combine multiple files together?”</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>“Use Snakemake to process all our samples at once”</li>
<li>“Make a scalability plot that brings our results together”</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>We created a rule that can generate a single output file, but we’re
not going to create multiple rules for every output file. We want to
generate all of the run files with a single rule if we could, well
Snakemake can indeed take a list of input files:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="bu">input</span>:  <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_2.json"</span>, <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">/runs/amdahl_run_6.json"</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    shell:</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<p>That’s great, but we don’t want to have to list all of the files
we’re interested in individually. How can we do this?</p>
<section><h2 class="section-heading" id="defining-a-list-of-samples-to-process">Defining a list of samples to process<a class="anchor" aria-label="anchor" href="#defining-a-list-of-samples-to-process"></a>
</h2>
<hr class="half-width">
<p>To do this, we can define some lists as Snakemake <strong>global
variables</strong>.</p>
<p>Global variables should be added before the rules in the
Snakefile.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Task sizes we wish to run</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>NTASK_SIZES <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</span></code></pre>
</div>
<ul>
<li>Unlike with variables in shell scripts, we can put spaces around the
<code>=</code> sign, but they are not mandatory.</li>
<li>The lists of quoted strings are enclosed in square brackets and
comma-separated. If you know any Python you’ll recognise this as Python
list syntax.</li>
<li>A good convention is to use capitalized names for these variables,
but this is not mandatory.</li>
<li>Although these are referred to as variables, you can’t actually
change the values once the workflow is running, so lists defined this
way are more like constants.</li>
</ul></section><section><h2 class="section-heading" id="using-a-snakemake-rule-to-define-a-batch-of-outputs">Using a Snakemake rule to define a batch of outputs<a class="anchor" aria-label="anchor" href="#using-a-snakemake-rule-to-define-a-batch-of-outputs"></a>
</h2>
<hr class="half-width">
<p>Now let’s update our Snakefile to leverage the new global variable
and create a list of files:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    shell:</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        <span class="co">"echo {input} done &gt; {output}"</span></span></code></pre>
</div>
<p>The <code>expand(...)</code> function in this rule generates a list
of filenames, by taking the first thing in the single parentheses as a
template and replacing <code>{count}</code> with all the
<code>NTASK_SIZES</code>. Since there are 5 elements in the list, this
will yield 5 files we want to make. Note that we had to protect our
wildcard in a second set of parentheses so it wouldn’t be interpreted as
something that needed to be expanded.</p>
<p>In our current case we still rely on the file name to define the
value of the wildcard <code>parallel_proportion</code> so we can’t call
the rule directly, we still need to request a specific file:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.999_runs.txt</span></code></pre>
</div>
<p>If you don’t specify a target rule name or any file names on the
command line when running Snakemake, the default is to use <strong>the
first rule</strong> in the Snakefile as the target.</p>
<div id="rules-as-targets" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="rules-as-targets" class="callout-inner">
<h3 class="callout-title">Rules as targets</h3>
<div class="callout-content">
<p>Giving the name of a rule to Snakemake on the command line only works
when that rule has <em>no wildcards</em> in the outputs, because
Snakemake has no way to know what the desired wildcards might be. You
will see the error “Target rules may not contain wildcards.” This can
also happen when you don’t supply any explicit targets on the command
line at all, and Snakemake tries to runthe first rule defined in the
Snakefile.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="rules-that-combine-multiple-inputs">Rules that combine multiple inputs<a class="anchor" aria-label="anchor" href="#rules-that-combine-multiple-inputs"></a>
</h2>
<hr class="half-width">
<p>Our <code>generate_run_files</code> rule is a rule which takes a list
of input files. The length of that list is not fixed by the rule, but
can change based on <code>NTASK_SIZES</code>.</p>
<p>In our workflow the final step is to take all the generated files and
combine them into a plot. To do that, you may have heard that some
people use a python library called <code>matplotlib</code>. It’s beyond
the scope of this tutorial to write the python script to create a final
plot, so we provide you with the script as part of this lesson. You can
download it with</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-O</span> https://ocaisa.github.io/hpc-workflows/files/plot_terse_amdahl_results.py</span></code></pre>
</div>
<p>The script <code>plot_terse_amdahl_results.py</code> needs a command
line that looks like:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">python</span> plot_terse_amdahl_results.py <span class="at">--output</span> <span class="op">&lt;</span>output image filename<span class="op">&gt;</span> <span class="op">&lt;</span>1st input file<span class="op">&gt;</span> <span class="op">&lt;</span>2nd input file<span class="op">&gt;</span> ...</span></code></pre>
</div>
<p>Let’s introduce that into our <code>generate_run_files</code>
rule:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_runs.txt"</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    shell:</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        <span class="co">"python plot_terse_amdahl_results.py --output {output} {input}"</span></span></code></pre>
</div>
<div id="challenge1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>This script relies on <code>matplotlib</code>, is it available as an
environment module? Add this requirement to our rule.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>rule generate_run_files:</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    output: <span class="st">"p_</span><span class="sc">{parallel_proportion}</span><span class="st">_scalability.jpg"</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="bu">input</span>:  expand(<span class="st">"p_</span><span class="sc">{{</span><span class="st">parallel_proportion</span><span class="sc">}}</span><span class="st">/runs/amdahl_run_</span><span class="sc">{count}</span><span class="st">.json"</span>, count<span class="op">=</span>NTASK_SIZES)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    envmodules:</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>      <span class="co">"matplotlib"</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    shell:</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>        <span class="co">"python plot_terse_amdahl_results.py --output {output} {input}"</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Now we finally get to generate a scaling plot! Run the final
Snakemake command:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.999_scalability.jpg</span></code></pre>
</div>
<div id="challenge2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Generate the scalability plot for all values from 1 to 10 cores.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>NTASK_SIZES <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="challenge3" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Rerun the workflow for a <code>p</code> value of 0.8</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">snakemake</span> <span class="at">--profile</span> cluster_profile/ p_0.8_scalability.jpg</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="bonus-round" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="bonus-round" class="callout-inner">
<h3 class="callout-title">Bonus round</h3>
<div class="callout-content">
<p>Create a final rule that can be called directly and generates a
scaling plot for 3 different values of <code>p</code>.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>“Use the <code>expand()</code> function to generate lists of
filenames you want to combine”</li>
<li>“Any <code>{input}</code> to a rule can be a variable-length
list”</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/carpentries-incubator/hpc-workflows/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries-incubator/hpc-workflows/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/hpc-workflows/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:maintainers-hpc@lists.carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY-4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.7" class="external-link">pegboard (0.7.7)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/hpc-workflows/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "HPC Carpentry, snakemake, workflows, hpc",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/hpc-workflows/aio.html",
  "identifier": "https://carpentries-incubator.github.io/hpc-workflows/aio.html",
  "dateCreated": "2023-04-19",
  "dateModified": "2025-01-28",
  "datePublished": "2025-01-28"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

